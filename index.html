<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Indian Atlas Sleep</title>
    <style>
        /* SLEEP UI: Pitch Black */
        body {
            background-color: #000000;
            color: #555;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: manipulation;
        }

        #stars-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .star-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
        }

        .star-layer.layer-1 { animation: space-travel-1 180s linear infinite; }
        .star-layer.layer-2 { animation: space-travel-2 120s linear infinite; }
        .star-layer.layer-3 { animation: space-travel-3 60s linear infinite; }

        .star {
            position: absolute;
            border-radius: 50%;
            background-color: #fff;
        }

        @keyframes space-travel-1 {
            from { transform: translateY(0px); }
            to   { transform: translateY(-200px); }
        }
        @keyframes space-travel-2 {
            from { transform: translateY(0px); }
            to   { transform: translateY(-400px); }
        }
        @keyframes space-travel-3 {
            from { transform: translateY(0px); }
            to   { transform: translateY(-600px); }
        }

        /* The Breathing Core */
        #core {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #0D0D15;
            transition: all 1s ease;
            box-shadow: 0 0 20px rgba(12, 12, 20, 0.8), inset 0 0 15px rgba(12, 12, 20, 0.9);
            margin-bottom: 40px;
            z-index: 1;
        }

        /* States */
        .listening {
            background: #152838 !important; /* Muted Navy */
            animation: breathe 5s infinite ease-in-out;
            box-shadow: 
                0 0 40px rgba(30, 60, 90, 0.6),
                0 0 80px rgba(50, 100, 150, 0.3),
                inset 0 0 20px rgba(30, 60, 90, 0.5);
        }
        .speaking {
            background: #382815 !important; /* Muted Amber */
             box-shadow: 
                0 0 35px rgba(90, 60, 30, 0.5),
                0 0 70px rgba(140, 90, 50, 0.2),
                inset 0 0 15px rgba(90, 60, 30, 0.4);
            transform: scale(1.05);
        }

        @keyframes breathe {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.15); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        #status {
            font-size: 18px;
            font-weight: 300;
            color: #444;
            min-height: 24px;
            text-align: center;
            z-index: 1;
        }

        /* Controls */
        .controls {
            position: absolute;
            bottom: 50px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 80%;
            max-width: 300px;
            z-index: 1;
        }
        
        .persistent-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            opacity: 0;
            animation: fadeIn 1s ease 0.5s forwards;
            z-index: 1;
        }

        select {
            padding: 12px;
            background: #111;
            color: #888;
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            width: 100%;
        }

        button {
            padding: 16px;
            background: #222;
            color: #ccc;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:active { background: #333; }
        
        .hidden { display: none !important; }

        @keyframes fadeIn {
            to { opacity: 0.5; }
        }
    </style>
</head>
<body>

        <div id="stars-container">
            <div class="star-layer layer-1"></div>
            <div class="star-layer layer-2"></div>
            <div class="star-layer layer-3"></div>
        </div>
        <div id="core"></div>

        <div id="status">...</div>

    
        <div class="persistent-controls">
            <select id="soundSelect" onchange="soundChanged()">
                <option value="none">No Sound</option>
                <option value="rain">Rain</option>
                <option value="white">White Noise</option>
                <option value="pink">Pink Noise</option>
            </select>
            <button onclick="toggleSound()" id="soundBtn">Turn On</button>
        </div>

        <div class="controls" id="setupPanel">
            <select id="voiceSelect" onchange="testVoice()">
                <option value="">Loading voices...</option>
            </select>
            <div style="display: flex; gap: 10px;">
                <button onclick="initGame()" style="flex:2;">Start Sleep Session</button>
            </div>
        </div>

    

    <script src="cities.js"></script>

    <script>
        // --- STARFIELD ---
        function createStars() {
            const layers = document.querySelectorAll('.star-layer');
            layers.forEach((layer, layerIndex) => {
                const numStars = (layerIndex + 1) * 150; // More stars on faster layers
                for (let i = 0; i < numStars; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    const size = Math.random() * (2.5 - (layerIndex * 0.5));
                    star.style.width = `${size}px`;
                    star.style.height = `${size}px`;
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.top = `${Math.random() * 120 - 20}%`; // Start some off-screen
                    star.style.opacity = Math.random() * 0.8 + 0.2;
                    layer.appendChild(star);
                }
            });
        }
        createStars();

        // --- SLEEP ENGINE ---

        

        const SLEEP_TIMEOUT_MS = 10 * 60 * 1000; // 10 Minutes

        const FILLERS = ["Hmm... ", "Let me see... ", "Okay... ", "Right... ", "Thinking... ", "Ah... ", "Good one... ", ""];

    

                let usedWords = new Set();

    

                let lastLetter = null;

    

                let voices = [];

    

                let recognition;

    

                let sleepTimer;

    

                let audioCtx;

    

                let soundNode;

    

                let isSoundOn = false;

    

                const synth = window.speechSynthesis;

    

        

    

                // --- 1. VOICE SETUP ---

    

                function loadVoices() {

    

                    voices = synth.getVoices();

    

                    const select = document.getElementById('voiceSelect');

    

                    const savedVoiceName = localStorage.getItem('selectedVoice');

    

                    select.innerHTML = '';

    

                    console.log(`Found ${voices.length} voices.`);

    

        

    

                    voices.sort((a, b) => {

    

                        const aScore = (a.name.includes("Google") ? 2 : 0) + (a.lang.includes("IN") ? 1 : 0);

    

                        const bScore = (b.name.includes("Google") ? 2 : 0) + (b.lang.includes("IN") ? 1 : 0);

    

                        return bScore - aScore;

    

                    });

    

        

    

                    let savedVoiceExists = false;

    

                    voices.forEach((voice) => {

    

                        const option = document.createElement('option');

    

                        option.textContent = `${voice.name} (${voice.lang})`;

    

                        option.value = voice.name;

    

                        if (voice.name === savedVoiceName) {

    

                            option.selected = true;

    

                            savedVoiceExists = true;

    

                        }

    

                        select.appendChild(option);

    

                    });

    

        

    

                    if (!savedVoiceExists && voices.length > 0) {

    

                         localStorage.setItem('selectedVoice', voices[0].name);

    

                    }

    

                }

    

        

    

                loadVoices();

    

                if (speechSynthesis.onvoiceschanged !== undefined) {

    

                    speechSynthesis.onvoiceschanged = loadVoices;

    

                }

    

        

    

                function testVoice() {

    

                    const name = document.getElementById('voiceSelect').value;

    

                    localStorage.setItem('selectedVoice', name);

    

                    speak("Is this soothing enough?", false);

    

                }

    

        

    

                function speak(text, callback) {

    

                    resetSleepTimer();

    

                    document.getElementById('core').className = 'speaking';

    

                    document.getElementById('status').innerText = text;

    

        

    

                    const u = new SpeechSynthesisUtterance(text);

    

                    

    

                    // Just-in-time voice selection for robustness

    

                    if (voices.length === 0) {

    

                        voices = synth.getVoices(); // Try fetching again

    

                    }

    

                    const selectedVoiceName = localStorage.getItem('selectedVoice');

    

                    const selectedVoice = voices.find(v => v.name === selectedVoiceName);

    

        

    

                    if (selectedVoice) {

    

                        u.voice = selectedVoice;

    

                        console.log(`Using voice: ${selectedVoice.name}`);

    

                    } else {

    

                        console.log("Selected voice not found, using default.");

    

                    }

    

        

    

                    u.rate = 0.8;

    

                    u.pitch = 0.85;

    

                    u.onend = () => {

    

                        document.getElementById('core').className = '';

    

                        if (callback) callback();

    

                    };

    

                    synth.speak(u);

    

                }

    

        

    

                // --- 2. AMBIENT SOUND ENGINE ---

    

                function soundChanged() {

    

                    if (isSoundOn) {

    

                        if (soundNode) soundNode.disconnect();

    

                        initAudio();

    

                        audioCtx.resume();

    

                    }

    

                }

    

        

    

                function toggleSound() {

    

                    const sound = document.getElementById('soundSelect').value;

    

                    if (sound === 'none') return;

    

        

    

                    if (isSoundOn) {

    

                        if (audioCtx) audioCtx.suspend();

    

                        document.getElementById('soundBtn').innerText = "Turn On";

    

                        isSoundOn = false;

    

                    } else {

    

                        if (!audioCtx) initAudio();

    

                        audioCtx.resume();

    

                        document.getElementById('soundBtn').innerText = "Turn Off";

    

                        isSoundOn = true;

    

                    }

    

                }

    

        

    

                function initAudio() {

    

                    if (audioCtx) {

    

                        audioCtx.close();

    

                    }

    

                    const AudioContext = window.AudioContext || window.webkitAudioContext;

    

                    audioCtx = new AudioContext();

    

        

    

                    const soundType = document.getElementById('soundSelect').value;

    

                    if (soundType === 'none') return;

    

        

    

                    const bufferSize = audioCtx.sampleRate * 2;

    

                    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);

    

                    const data = buffer.getChannelData(0);

    

        

    

                    // Noise generation

    

                    if (soundType === 'rain') { // Brown Noise

    

                        let lastOut = 0;

    

                        for (let i = 0; i < bufferSize; i++) {

    

                            const white = Math.random() * 2 - 1;

    

                            lastOut = (lastOut + (0.02 * white)) / 1.02;

    

                            data[i] = lastOut * 3.5;

    

                        }

    

                    } else if (soundType === 'white') { // White Noise

    

                        for (let i = 0; i < bufferSize; i++) {

    

                            data[i] = (Math.random() * 2 - 1) * 0.4;

    

                        }

    

                    } else if (soundType === 'pink') { // Pink Noise

    

                        let b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0, b6 = 0;

    

                        for (let i = 0; i < bufferSize; i++) {

    

                            const white = Math.random() * 2 - 1;

    

                            b0 = 0.99886 * b0 + white * 0.0555179;

    

                            b1 = 0.99332 * b1 + white * 0.0750759;

    

                            b2 = 0.96900 * b2 + white * 0.1538520;

    

                            b3 = 0.86650 * b3 + white * 0.3104856;

    

                            b4 = 0.55000 * b4 + white * 0.5329522;

    

                            b5 = -0.7616 * b5 - white * 0.0168980;

    

                            data[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362) * 0.11;

    

                            b6 = white * 0.115926;

    

                        }

    

                    }

    

        

    

                    soundNode = audioCtx.createBufferSource();

    

                    soundNode.buffer = buffer;

    

                    soundNode.loop = true;

    

        

    

                    // Filtering for rain sound

    

                    if (soundType === 'rain') {

    

                        const filter = audioCtx.createBiquadFilter();

    

                        filter.type = 'lowpass';

    

                        filter.frequency.value = 400;

    

                        soundNode.connect(filter);

    

                        filter.connect(audioCtx.destination);

    

                    } else {

    

                        soundNode.connect(audioCtx.destination);

    

                    }

    

                    

    

                    soundNode.start(0);

    

                    audioCtx.suspend(); // Start suspended

    

                }

    

        

    

                // --- 3. SILENT KILL TIMER ---

    

                function resetSleepTimer() {

    

                    clearTimeout(sleepTimer);

    

                    sleepTimer = setTimeout(enterDeepSleep, SLEEP_TIMEOUT_MS);

    

                }

    

        

    

                function enterDeepSleep() {

    

                    if (recognition) {

    

                        recognition.onresult = null;

    

                        recognition.onerror = null;

    

                        recognition.onend = null;

    

                        try { recognition.stop(); } catch(e){}

    

                    }

    

                    synth.cancel(); // Stop any current speech

    

                    if (audioCtx) audioCtx.close();

    

                    document.body.style.backgroundColor = "#000";

    

                    document.getElementById('core').style.display = 'none';

    

                    document.getElementById('status').innerText = "";

    

                }

    

        

    

                // --- 4. GAME LOGIC ---

    

                function initGame() {

    

                    loadVoices(); // Explicitly load voices on user action

    

                    document.getElementById('setupPanel').classList.add('hidden');

    

                    try { navigator.wakeLock.request('screen'); } catch(e){}

    

                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    

                    recognition = new SpeechRecognition();

            recognition.lang = "en-IN";

            recognition.onresult = (event) => {

                const heard = event.results[0][0].transcript.trim().replace(".","");

                document.getElementById('status').innerText = `You: ${heard}`;

                resetSleepTimer();

                processMove(heard);

            };

            recognition.onend = () => {

                if (document.getElementById('core').className === 'listening') {

                    try { recognition.start(); } catch(e){}

                }

            };

            resetSleepTimer();

            speak("Close your eyes. Relax. I will start. Mumbai.", () => {

                usedWords.add("Mumbai");

                lastLetter = "i";

                listen();

            });

        }

    

        function listen() {

            document.getElementById('core').className = 'listening';

            document.getElementById('status').innerText = "Listening...";

            try { recognition.start(); } catch(e){}

        }

    

        function processMove(rawWord) {

            const city = rawWord.split(" ")[0]; 

            const cleanCity = city.charAt(0).toUpperCase() + city.slice(1).toLowerCase();

            if (!CITIES_DB.includes(cleanCity)) {

                speak(`Hmm... let's try a word with ${lastLetter}.`, listen);

                return;

            }

            if (usedWords.has(cleanCity) || cleanCity.toLowerCase().charAt(0) !== lastLetter.toLowerCase()) {

                speak(`Try another one with ${lastLetter}.`, listen);

                return;

            }

            usedWords.add(cleanCity);

            const nextChar = cleanCity.slice(-1);

            setTimeout(() => botReply(nextChar), Math.random() * 2000 + 2000);

        }

    

        function botReply(char) {

            const candidates = CITIES_DB.filter(c => c.toLowerCase().startsWith(char.toLowerCase()) && !usedWords.has(c));

            if (candidates.length === 0) {

                enterDeepSleep(); // End silently if stuck

                return;

            }

            const choice = candidates[Math.floor(Math.random() * candidates.length)];

            usedWords.add(choice);

            lastLetter = choice.slice(-1);

            let prefix = Math.random() > 0.6 ? FILLERS[Math.floor(Math.random() * FILLERS.length)] : "";

            speak(`${prefix} ${choice}. Your turn with ${lastLetter}.`, listen);

        }

    </script>
</body>
</html>